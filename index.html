<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TCK Record Book - Cloud</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Pyodide for Excel Generation -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .new-row, .modal-backdrop { animation: fadeIn 0.5s ease-out; }
    select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        padding-right: 2.5rem;
        -webkit-appearance: none; -moz-appearance: none; appearance: none;
    }
    .hidden { display: none; }
    @keyframes toast-in {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes toast-out {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100%); }
    }
    .toast { animation: toast-in 0.5s ease-out forwards; }
    .toast.fading-out { animation: toast-out 0.5s ease-in forwards; }
  </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center justify-center p-4 md:p-6 font-sans">

  <!-- Login View -->
  <div id="login-view" class="w-full max-w-md">
    <div class="bg-white rounded-2xl shadow-lg p-8">
        <h1 class="text-3xl font-bold text-gray-800 text-center mb-2">TCK Record Book</h1>
        <p class="text-center text-gray-500 mb-8">Sign in to access your cloud journal</p>
        <div id="auth-error" class="text-red-500 text-sm text-center mb-4"></div>
        <form id="loginForm" class="grid grid-cols-1 gap-4">
            <div>
                <label for="email" class="block text-sm font-medium text-gray-700">Email</label>
                <input type="email" id="email" placeholder="you@example.com" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2" />
            </div>
            <div>
                <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                <input type="password" id="password" placeholder="••••••••" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2" />
            </div>
            <div class="flex flex-col sm:flex-row gap-2 mt-4">
              <button type="submit" id="loginBtn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
                  Sign In
              </button>
              <button type="button" id="signupBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
                  Sign Up
              </button>
            </div>
        </form>
    </div>
  </div>

  <!-- Main App View -->
  <div id="app-view" class="w-full max-w-7xl hidden">
    <header class="flex justify-between items-center mb-6 flex-wrap gap-4">
      <h1 class="text-4xl font-bold text-gray-800">TCK Record Book</h1>
      <div class="flex items-center gap-4">
        <span id="syncStatus" class="text-sm text-gray-500 flex items-center gap-1"></span>
        <span id="userEmail" class="text-sm text-gray-600"></span>
        <button id="signOutBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
            Sign Out
        </button>
      </div>
    </header>

    <!-- Dashboard/Summary View -->
    <div class="bg-white rounded-2xl shadow-lg p-6 w-full mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4">This Month's Summary</h2>
        <div id="dashboard-content" class="grid grid-cols-1 md:grid-cols-3 gap-6 text-center">
            <div>
                <p class="text-sm text-gray-500">Total Income</p>
                <p id="summary-income" class="text-2xl font-bold text-green-600">UGX 0</p>
            </div>
            <div>
                <p class="text-sm text-gray-500">Total Expense</p>
                <p id="summary-expense" class="text-2xl font-bold text-red-600">UGX 0</p>
            </div>
            <div>
                <p class="text-sm text-gray-500">Overall Balance</p>
                <p id="summary-balance" class="text-2xl font-bold text-indigo-600">UGX 0</p>
            </div>
        </div>
        <div id="dashboard-message" class="text-center text-gray-500 mt-4 hidden">Select a journal to see the summary.</div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      
      <div class="lg:col-span-1 flex flex-col gap-8">
        <!-- Add New Entry Form -->
        <div class="bg-white rounded-2xl shadow-lg p-6 w-full">
          <h2 class="text-xl font-bold text-gray-800 mb-4">Add New Entry</h2>
          <form id="entryForm" class="grid grid-cols-1 gap-4">
            <div>
              <label for="date" class="block text-sm font-medium text-gray-700">Date</label>
              <input type="text" id="date" placeholder="dd/mm/yyyy" required maxlength="10" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2" />
            </div>
            <div>
              <label for="type" class="block text-sm font-medium text-gray-700">Entry Type</label>
              <select id="type" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                <option value="Income">Income</option>
                <option value="Expense" selected>Expense</option>
              </select>
            </div>
            <div>
              <label for="method" class="block text-sm font-medium text-gray-700">Source / Method</label>
              <select id="method" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                <option value="Mobile Money">Mobile Money</option>
                <option value="Bank">Bank</option>
                <option value="Cash">Cash</option>
              </select>
            </div>
            <div>
              <label for="narration" class="block text-sm font-medium text-gray-700">Narration / Category</label>
              <input type="text" id="narration" placeholder="e.g. Salary, Rent, Groceries" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2" />
            </div>
            <div>
              <label for="amount" class="block text-sm font-medium text-gray-700">Amount (UGX)</label>
              <input type="number" id="amount" min="0" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2" />
            </div>
            <button type="submit" id="addEntryBtn" class="mt-3 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 disabled:opacity-50">
              Add Entry
            </button>
          </form>
        </div>

        <!-- Journal Management -->
        <div class="bg-white rounded-2xl shadow-lg p-6 w-full">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Manage Journals</h2>
            <div class="space-y-4">
                <div>
                    <label for="journalSelector" class="block text-sm font-medium text-gray-700">Current Journal</label>
                    <select id="journalSelector" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2"></select>
                </div>
                <button id="createJournalBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
                    Create New Journal
                </button>
                <button id="renameJournalBtn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
                    Rename Current Journal
                </button>
                <button id="deleteJournalBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 disabled:opacity-50" disabled>
                    Delete Current Journal
                </button>
            </div>
        </div>
        
        <!-- Data Management -->
        <div class="bg-white rounded-2xl shadow-lg p-6 w-full">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Data Management</h2>
            <div class="space-y-4">
                 <button id="downloadBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Download Excel
                </button>
                <button id="downloadBackupBtn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
                    Download Backup (JSON)
                </button>
                <button id="importBackupBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
                    Import from Backup
                </button>
                <input type="file" id="fileImporter" class="hidden" accept=".json">
            </div>
        </div>
      </div>

      <!-- Entries Table -->
      <div class="lg:col-span-2 flex flex-col gap-8">
        <div class="w-full bg-white rounded-2xl shadow-lg overflow-hidden">
          <div class="p-6">
            <div class="flex justify-between items-center flex-wrap gap-4 mb-4">
                <h2 id="entriesTitle" class="text-xl font-bold text-gray-800">Entries</h2>
            </div>
            
            <div class="mb-4">
                <label for="search-input" class="sr-only">Search Entries</label>
                <input type="search" id="search-input" placeholder="Search by narration..." class="w-full rounded-lg border-gray-300 shadow-sm p-2 text-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 pb-4 border-b border-gray-200">
                <div>
                    <label for="sort-by" class="block text-sm font-medium text-gray-700">Sort by</label>
                    <select id="sort-by" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 text-sm">
                        <option value="date_desc">Newest First</option>
                        <option value="date_asc">Oldest First</option>
                        <option value="amount_desc">Amount (High-Low)</option>
                        <option value="amount_asc">Amount (Low-High)</option>
                    </select>
                </div>
                <div>
                    <label for="filter-type" class="block text-sm font-medium text-gray-700">Type</label>
                    <select id="filter-type" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 text-sm">
                        <option value="all">All</option>
                        <option value="Income">Income</option>
                        <option value="Expense">Expense</option>
                    </select>
                </div>
                <div>
                    <label for="filter-method" class="block text-sm font-medium text-gray-700">Method</label>
                    <select id="filter-method" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm p-2 text-sm">
                        <option value="all">All</option>
                        <option value="Mobile Money">Mobile Money</option>
                        <option value="Bank">Bank</option>
                        <option value="Cash">Cash</option>
                    </select>
                </div>
                 <div>
                    <label for="reset-filters" class="block text-sm font-medium text-transparent">Reset</label>
                    <button id="reset-filters" class="w-full mt-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg text-sm">
                        Reset
                    </button>
                </div>
            </div>
             <p id="statusMessage" class="text-center text-sm text-gray-600 mt-1 h-5"></p>
          </div>
          
          <div class="overflow-x-auto">
            <table id="entriesTable" class="min-w-full text-sm">
              <thead class="bg-gray-100 border-b border-gray-200">
                <tr class="text-left text-gray-600 uppercase tracking-wider">
                  <th class="py-3 px-4">Date</th>
                  <th class="py-3 px-4">Type</th>
                  <th class="py-3 px-4">Method</th>
                  <th class="py-3 px-4">Narration</th>
                  <th class="py-3 px-4 text-right">Amount</th>
                  <th class="py-3 px-4 text-center">Actions</th>
                </tr>
              </thead>
              <tbody id="tableBody" class="divide-y divide-gray-200"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmationModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop">
      <div class="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 text-center">
          <h3 id="modalTitle" class="text-lg font-bold text-gray-900 mb-2">Are you sure?</h3>
          <p id="modalMessage" class="text-sm text-gray-600 mb-6">This action cannot be undone.</p>
          <div class="flex justify-center gap-4">
              <button id="modalCancelBtn" class="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold transition-colors">Cancel</button>
              <button id="modalConfirmBtn" class="px-6 py-2 rounded-lg bg-red-600 hover:bg-red-700 text-white font-semibold transition-colors">Confirm</button>
          </div>
      </div>
  </div>

  <!-- Edit Entry Modal -->
    <div id="editEntryModal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden modal-backdrop">
        <div class="bg-white rounded-2xl shadow-xl max-w-md w-full p-6">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Edit Entry</h3>
            <form id="editEntryForm" class="grid grid-cols-1 gap-4">
                <input type="hidden" id="editEntryId">
                <div>
                    <label for="editDate" class="block text-sm font-medium text-gray-700">Date</label>
                    <input type="text" id="editDate" placeholder="dd/mm/yyyy" required maxlength="10" class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2" />
                </div>
                <div>
                    <label for="editType" class="block text-sm font-medium text-gray-700">Entry Type</label>
                    <select id="editType" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        <option value="Income">Income</option>
                        <option value="Expense">Expense</option>
                    </select>
                </div>
                <div>
                    <label for="editMethod" class="block text-sm font-medium text-gray-700">Source / Method</label>
                    <select id="editMethod" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2">
                        <option value="Mobile Money">Mobile Money</option>
                        <option value="Bank">Bank</option>
                        <option value="Cash">Cash</option>
                    </select>
                </div>
                <div>
                    <label for="editNarration" class="block text-sm font-medium text-gray-700">Narration / Category</label>
                    <input type="text" id="editNarration" placeholder="e.g. Salary, Rent, Groceries" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2" />
                </div>
                <div>
                    <label for="editAmount" class="block text-sm font-medium text-gray-700">Amount (UGX)</label>
                    <input type="number" id="editAmount" min="0" required class="mt-1 w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50 p-2" />
                </div>
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" id="editCancelBtn" class="px-6 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold transition-colors">Cancel</button>
                    <button type="submit" class="px-6 py-2 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white font-semibold transition-colors">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

  <!-- Toast Notification Container -->
  <div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-2"></div>

  <!-- Firebase and App Logic -->
  <script type="module">
    // --- FIREBASE SDK IMPORTS ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        setDoc, 
        onSnapshot 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- FIREBASE CONFIGURATION ---
    const firebaseConfig = {
      apiKey: "AIzaSyBP4p26TLOqL9muN5JndpUZolaunzQgKC0",
      authDomain: "ie-entry.firebaseapp.com",
      projectId: "ie-entry",
      storageBucket: "ie-entry.appspot.com",
      messagingSenderId: "864058205761",
      appId: "1:864058205761:web:a70f7e3e20f0df3a8708c0",
      measurementId: "G-327XF816YG"
    };

    // --- FIREBASE INITIALIZATION ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- DOM ELEMENT REFERENCES ---
    const loginView = document.getElementById('login-view');
    const appView = document.getElementById('app-view');
    const loginForm = document.getElementById('loginForm');
    const signupBtn = document.getElementById('signupBtn');
    const signOutBtn = document.getElementById('signOutBtn');
    const authError = document.getElementById('auth-error');
    const userEmailSpan = document.getElementById('userEmail');
    const syncStatus = document.getElementById('syncStatus');
    const entryForm = document.getElementById('entryForm');
    const tableBody = document.getElementById('tableBody');
    const downloadBtn = document.getElementById('downloadBtn');
    const downloadBackupBtn = document.getElementById('downloadBackupBtn');
    const importBackupBtn = document.getElementById('importBackupBtn');
    const fileImporter = document.getElementById('fileImporter');
    const statusMessage = document.getElementById('statusMessage');
    const journalSelector = document.getElementById('journalSelector');
    const createJournalBtn = document.getElementById('createJournalBtn');
    const renameJournalBtn = document.getElementById('renameJournalBtn');
    const deleteJournalBtn = document.getElementById('deleteJournalBtn');
    const entriesTitle = document.getElementById('entriesTitle');
    const addEntryBtn = document.getElementById('addEntryBtn');
    const dateInput = document.getElementById('date');
    const typeSelect = document.getElementById('type');
    const methodSelect = document.getElementById('method');
    const searchInput = document.getElementById('search-input');
    const sortBySelect = document.getElementById('sort-by');
    const filterTypeSelect = document.getElementById('filter-type');
    const filterMethodSelect = document.getElementById('filter-method');
    const resetFiltersBtn = document.getElementById('reset-filters');
    const confirmationModal = document.getElementById('confirmationModal');
    const modalMessage = document.getElementById('modalMessage');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const editEntryModal = document.getElementById('editEntryModal');
    const editEntryForm = document.getElementById('editEntryForm');
    const editCancelBtn = document.getElementById('editCancelBtn');
    const editDateInput = document.getElementById('editDate');
    const dashboardContent = document.getElementById('dashboard-content');
    const dashboardMessage = document.getElementById('dashboard-message');
    const summaryIncome = document.getElementById('summary-income');
    const summaryExpense = document.getElementById('summary-expense');
    const summaryBalance = document.getElementById('summary-balance');

    // --- APP STATE ---
    let appData = {};
    let currentUser = null;
    let unsubscribeFromFirestore = null; 
    let confirmCallback = null;
    let viewOptions = {
        sortBy: 'date_desc',
        filterByType: 'all',
        filterByMethod: 'all',
        searchTerm: ''
    };
    let syncTimeout;
    let inactivityTimer;

    // --- INACTIVITY LOGOUT & NOTIFICATIONS ---
    const activityEvents = ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'];

    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const colors = { success: 'bg-green-600', error: 'bg-red-600', info: 'bg-blue-600' };
        toast.className = `toast text-white py-2 px-4 rounded-lg shadow-xl ${colors[type] || colors.info}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('fading-out');
            toast.addEventListener('animationend', () => toast.remove());
        }, 3000);
    }

    function logoutDueToInactivity() {
        if (auth.currentUser) {
            signOut(auth);
            showToast("Logged out due to inactivity", "info");
        }
    }

    function resetInactivityTimer() {
        clearTimeout(inactivityTimer);
        inactivityTimer = setTimeout(logoutDueToInactivity, 30 * 60 * 1000);
    }

    function setupInactivityListeners() {
        activityEvents.forEach(event => window.addEventListener(event, resetInactivityTimer, true));
        resetInactivityTimer();
    }

    function removeInactivityListeners() {
        clearTimeout(inactivityTimer);
        activityEvents.forEach(event => window.removeEventListener(event, resetInactivityTimer, true));
    }
    
    // --- UTILITY & PYODIDE ---
    function getFormattedDate(date, format = 'dd/mm/yyyy') {
        const d = new Date(date);
        const userTimezoneOffset = d.getTimezoneOffset() * 60000;
        const adjustedDate = new Date(d.getTime() + userTimezoneOffset);
        const yyyy = adjustedDate.getFullYear();
        const mm = String(adjustedDate.getMonth() + 1).padStart(2, '0');
        const dd = String(adjustedDate.getDate()).padStart(2, '0');
        return format === 'yyyy-mm-dd' ? `${yyyy}-${mm}-${dd}` : `${dd}/${mm}/${yyyy}`;
    }

    let pyodideReadyPromise;
    async function loadPy() {
      if (!pyodideReadyPromise) {
        statusMessage.textContent = 'Initializing Excel exporter...';
        pyodideReadyPromise = loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.25.0/full/" }).then(async (pyodide) => {
          statusMessage.textContent = 'Loading libraries...';
          await pyodide.loadPackage(['micropip']);
          const micropip = pyodide.pyimport("micropip");
          await micropip.install('openpyxl==3.1.2');
          statusMessage.textContent = '';
          return pyodide;
        });
      }
      return pyodideReadyPromise;
    }
    
    // --- AUTHENTICATION LOGIC ---
    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
            loginView.classList.add('hidden');
            appView.classList.remove('hidden');
            userEmailSpan.textContent = user.email;
            loadDataFromFirestore();
            loadPy(); 
            setupInactivityListeners();
        } else {
            currentUser = null;
            if (unsubscribeFromFirestore) unsubscribeFromFirestore();
            appView.classList.add('hidden');
            loginView.classList.remove('hidden');
            userEmailSpan.textContent = '';
            syncStatus.innerHTML = '';
            appData = {}; 
            updateUI();
            removeInactivityListeners();
        }
    });

    loginForm.addEventListener('submit', (e) => {
        e.preventDefault();
        signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('password').value)
            .catch(error => authError.textContent = error.message);
    });

    signupBtn.addEventListener('click', () => {
        const password = document.getElementById('password').value;
        if (password.length < 6) {
            authError.textContent = "Password should be at least 6 characters.";
            return;
        }
        createUserWithEmailAndPassword(auth, document.getElementById('email').value, password)
            .catch(error => authError.textContent = error.message);
    });

    signOutBtn.addEventListener('click', () => {
        signOut(auth).catch(error => showToast(error.message, 'error'));
    });

    // --- DATA HANDLING ---
    function loadDataFromFirestore() {
        if (!currentUser) return;
        const docRef = doc(db, "users", currentUser.uid);
        unsubscribeFromFirestore = onSnapshot(docRef, (docSnap) => {
            if (docSnap.exists()) {
                appData = docSnap.data();
            } else {
                initializeNewState();
                saveDataToFirestore(); 
            }
            updateUI();
        }, (error) => showToast("Error connecting to cloud data.", 'error'));
    }

    function initializeNewState() {
        const firstJournalId = `journal_${Date.now()}`;
        appData = {
            journals: { [firstJournalId]: { name: "My First Journal", entries: [] } },
            activeJournalId: firstJournalId
        };
    }

    async function saveDataToFirestore() {
        if (!currentUser) return;
        clearTimeout(syncTimeout);
        syncStatus.innerHTML = `<svg class="animate-spin h-4 w-4 text-yellow-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> <span>Saving...</span>`;
        try {
            await setDoc(doc(db, "users", currentUser.uid), appData); 
            syncStatus.innerHTML = `<span class="text-green-600">✓ Synced</span>`;
        } catch (error) {
            syncStatus.innerHTML = `<span class="text-red-600">✗ Sync failed</span>`;
            showToast('Failed to save data to cloud.', 'error');
        } finally {
            syncTimeout = setTimeout(() => syncStatus.innerHTML = '', 3000);
        }
    }
    
    // --- UI RENDERING & LOGIC ---
    function updateUI() {
        if (!appData.journals || Object.keys(appData.journals).length === 0) {
            const isLoggedIn = !!currentUser;
            entriesTitle.textContent = isLoggedIn ? "No Journal Selected" : "Please sign in";
            tableBody.innerHTML = `<tr id="placeholderRow"><td colspan="6" class="text-center py-10 text-gray-500">${isLoggedIn ? 'Create a journal to get started.' : 'Sign in to manage your journals.'}</td></tr>`;
            [addEntryBtn, deleteJournalBtn, downloadBtn, renameJournalBtn, downloadBackupBtn, searchInput].forEach(el => el.disabled = true);
            createJournalBtn.disabled = !isLoggedIn; importBackupBtn.disabled = !isLoggedIn;
            journalSelector.innerHTML = `<option>${isLoggedIn ? 'No Journals' : 'Not signed in'}</option>`;
            dashboardContent.classList.add('hidden'); dashboardMessage.classList.remove('hidden');
            return;
        }
        dashboardContent.classList.remove('hidden'); dashboardMessage.classList.add('hidden');
        loadJournalsIntoSelector();
        const activeId = appData.activeJournalId;
        const journalIds = Object.keys(appData.journals);
        setActiveJournal((activeId && appData.journals[activeId]) ? activeId : journalIds[0]);
    }

    function loadJournalsIntoSelector() {
        const sortedIds = Object.keys(appData.journals).sort((a,b) => appData.journals[a].name.localeCompare(appData.journals[b].name));
        journalSelector.innerHTML = '';
        sortedIds.forEach(id => {
            const journal = appData.journals[id];
            const option = document.createElement('option');
            option.value = id; option.textContent = journal.name;
            journalSelector.appendChild(option);
        });
    }

    function setActiveJournal(journalId) {
        appData.activeJournalId = journalId;
        journalSelector.value = journalId;
        const selectedJournal = appData.journals[journalId];
        entriesTitle.textContent = `Entries for: ${selectedJournal.name}`;
        [addEntryBtn, deleteJournalBtn, createJournalBtn, renameJournalBtn, downloadBackupBtn, importBackupBtn, searchInput].forEach(el => el.disabled = false);
        renderTable();
    }
    
    function getFilteredEntries() {
        const activeJournal = appData.journals[appData.activeJournalId];
        if (!activeJournal || !activeJournal.entries) return [];
        const searchTerm = viewOptions.searchTerm.toLowerCase();
        return activeJournal.entries.filter(e => {
            return (viewOptions.filterByType === 'all' || e.type === viewOptions.filterByType) &&
                   (viewOptions.filterByMethod === 'all' || e.method === viewOptions.filterByMethod) &&
                   (!searchTerm || e.narration.toLowerCase().includes(searchTerm));
        });
    }

    function renderTable() {
        updateDashboard();
        const entriesToRender = getFilteredEntries();
        tableBody.innerHTML = '';
        downloadBtn.disabled = entriesToRender.length === 0;

        if (entriesToRender.length === 0) {
            const hasEntries = appData.journals[appData.activeJournalId]?.entries?.length > 0;
            const message = hasEntries ? "No entries match your current filters." : "No entries in this journal.";
            tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-10 text-gray-500">${message}</td></tr>`;
            return;
        }
        
        const createRowElement = (entry) => {
            const tr = document.createElement('tr');
            tr.className = 'new-row'; tr.dataset.id = entry.id;
            tr.innerHTML = `
                <td class="py-3 px-4 whitespace-nowrap">${getFormattedDate(entry.date)}</td>
                <td class="py-3 px-4"><span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${entry.type === 'Income' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">${entry.type}</span></td>
                <td class="py-3 px-4 whitespace-nowrap">${entry.method}</td>
                <td class="py-3 px-4 break-words">${entry.narration}</td>
                <td class="py-3 px-4 text-right font-mono">${(entry.amount || 0).toLocaleString()}</td>
                <td class="py-3 px-4 text-center whitespace-nowrap">
                    <button data-id="${entry.id}" class="edit-btn text-indigo-500 hover:text-indigo-700 font-semibold transition-colors mr-2">Edit</button>
                    <button data-id="${entry.id}" class="delete-btn text-red-500 hover:text-red-700 font-semibold transition-colors">Delete</button>
                </td>`;
            return tr;
        };
        
        const groupedByMonth = entriesToRender.reduce((acc, entry) => {
            const month = entry.date.substring(0, 7);
            if (!acc[month]) acc[month] = [];
            acc[month].push(entry);
            return acc;
        }, {});

        const monthSortOrder = Object.keys(groupedByMonth).sort((a, b) => viewOptions.sortBy.includes('asc') ? a.localeCompare(b) : b.localeCompare(a));
        
        monthSortOrder.forEach(monthKey => {
            const monthName = new Date(monthKey + '-02').toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            const monthHeaderRow = document.createElement('tr');
            monthHeaderRow.className = 'bg-gray-200';
            monthHeaderRow.innerHTML = `<td colspan="6" class="py-2 px-4 text-gray-800 font-bold text-center">${monthName}</td>`;
            tableBody.appendChild(monthHeaderRow);

            let monthEntries = groupedByMonth[monthKey];
            if (viewOptions.sortBy === 'amount_asc') monthEntries.sort((a, b) => a.amount - b.amount);
            else if (viewOptions.sortBy === 'amount_desc') monthEntries.sort((a, b) => b.amount - a.amount);
            else {
                monthEntries.sort((a, b) => new Date(a.date) - new Date(b.date));
                if(viewOptions.sortBy === 'date_desc') monthEntries.reverse();
            }
            monthEntries.forEach(entry => tableBody.appendChild(createRowElement(entry)));
        });
    }

    function updateDashboard() {
        const activeJournal = appData.journals[appData.activeJournalId];
        if (!activeJournal || !activeJournal.entries) {
            summaryIncome.textContent = "UGX 0"; summaryExpense.textContent = "UGX 0"; summaryBalance.textContent = "UGX 0"; return;
        };
        const allEntries = activeJournal.entries;
        const now = new Date();
        const currentMonth = now.getFullYear() + '-' + String(now.getMonth() + 1).padStart(2, '0');
        const thisMonthEntries = allEntries.filter(e => e.date.startsWith(currentMonth));
        const monthlyIncome = thisMonthEntries.filter(e => e.type === 'Income').reduce((sum, e) => sum + e.amount, 0);
        const monthlyExpense = thisMonthEntries.filter(e => e.type === 'Expense').reduce((sum, e) => sum + e.amount, 0);
        const totalIncome = allEntries.filter(e => e.type === 'Income').reduce((sum, e) => sum + e.amount, 0);
        const totalExpense = allEntries.filter(e => e.type === 'Expense').reduce((sum, e) => sum + e.amount, 0);
        summaryIncome.textContent = `UGX ${monthlyIncome.toLocaleString()}`;
        summaryExpense.textContent = `UGX ${monthlyExpense.toLocaleString()}`;
        summaryBalance.textContent = `UGX ${(totalIncome - totalExpense).toLocaleString()}`;
    }

    function parseAndValidateDate(dateInputStr) {
        const dateParts = dateInputStr.split('/');
        if (dateParts.length !== 3 || dateParts[0].length !== 2 || dateParts[1].length !== 2 || dateParts[2].length !== 4) {
            showToast("Invalid date format. Please use DD/MM/YYYY.", 'error'); return null;
        }
        const [day, month, year] = dateParts.map(p => parseInt(p, 10));
        const dateObj = new Date(year, month - 1, day);
        if (isNaN(dateObj.getTime()) || dateObj.getFullYear() !== year || dateObj.getMonth() + 1 !== month || dateObj.getDate() !== day) {
            showToast("Invalid date. Please check the day, month, and year.", 'error'); return null;
        }
        return getFormattedDate(dateObj, 'yyyy-mm-dd');
    }

    // --- CRUD OPERATIONS ---
    function createNewJournal() {
        const journalName = window.prompt("Enter a name for the new journal:", "New Journal");
        if (!journalName || journalName.trim() === '') return; 
        const newId = `journal_${Date.now()}`;
        appData.journals[newId] = { name: journalName.trim(), entries: [] };
        appData.activeJournalId = newId;
        saveDataToFirestore().then(() => showToast("Journal created!", "success"));
    }

    function renameActiveJournal() {
        const activeJournal = appData.journals[appData.activeJournalId];
        if (!activeJournal) return;
        const newName = window.prompt("Enter new name for the journal:", activeJournal.name);
        if (newName && newName.trim() !== '') {
            activeJournal.name = newName.trim();
            saveDataToFirestore().then(() => showToast("Journal renamed!", "success"));
        }
    }

    function deleteActiveJournal() {
        const journalId = appData.activeJournalId;
        const journalName = appData.journals[journalId]?.name;
        if (!journalId || !journalName) return;
        delete appData.journals[journalId];
        const remainingIds = Object.keys(appData.journals);
        appData.activeJournalId = remainingIds.length > 0 ? remainingIds[0] : null;
        saveDataToFirestore().then(() => showToast(`'${journalName}' deleted.`, "info"));
    }

    function addEntry(e) {
        e.preventDefault();
        const activeJournal = appData.journals[appData.activeJournalId];
        if (!activeJournal) return;
        const formattedDate = parseAndValidateDate(dateInput.value);
        if (!formattedDate) return;

        if (!activeJournal.entries) activeJournal.entries = [];
        activeJournal.entries.push({
          id: `entry_${Date.now()}`, date: formattedDate,
          type: typeSelect.value, method: methodSelect.value,
          narration: document.getElementById('narration').value.trim(),
          amount: parseFloat(document.getElementById('amount').value)
        });
        saveDataToFirestore().then(() => showToast("Entry added", "success"));
        entryForm.reset();
        dateInput.value = getFormattedDate(new Date());
    }

    function openEditModal(entryId) {
        const entry = appData.journals[appData.activeJournalId]?.entries.find(e => e.id === entryId);
        if (!entry) return;
        document.getElementById('editEntryId').value = entry.id;
        editDateInput.value = getFormattedDate(entry.date, 'dd/mm/yyyy');
        document.getElementById('editType').value = entry.type;
        document.getElementById('editMethod').value = entry.method;
        document.getElementById('editNarration').value = entry.narration;
        document.getElementById('editAmount').value = entry.amount;
        editEntryModal.classList.remove('hidden');
    }

    function updateEntry(e) {
        e.preventDefault();
        const activeJournal = appData.journals[appData.activeJournalId];
        const entryId = document.getElementById('editEntryId').value;
        if (!activeJournal || !entryId) return;
        const formattedDate = parseAndValidateDate(editDateInput.value);
        if (!formattedDate) return;
        const entryIndex = activeJournal.entries.findIndex(e => e.id === entryId);
        if (entryIndex === -1) return;

        activeJournal.entries[entryIndex] = {
            id: entryId, date: formattedDate,
            type: document.getElementById('editType').value,
            method: document.getElementById('editMethod').value,
            narration: document.getElementById('editNarration').value.trim(),
            amount: parseFloat(document.getElementById('editAmount').value)
        };
        saveDataToFirestore().then(() => showToast("Entry updated", "success"));
        editEntryModal.classList.add('hidden');
    }

    function deleteEntry(entryId) {
        const activeJournal = appData.journals[appData.activeJournalId];
        if (!activeJournal) return;
        activeJournal.entries = activeJournal.entries.filter(entry => entry.id !== entryId);
        saveDataToFirestore().then(() => showToast("Entry deleted", "info"));
    }
    
    function showConfirmationModal(message, onConfirm) {
        modalMessage.textContent = message;
        confirmCallback = onConfirm;
        confirmationModal.classList.remove('hidden');
    }
    
    // --- EVENT LISTENERS ---
    searchInput.addEventListener('input', (e) => {
        viewOptions.searchTerm = e.target.value;
        renderTable();
    });
    
    [sortBySelect, filterTypeSelect, filterMethodSelect].forEach(el => {
        el.addEventListener('change', () => {
            viewOptions.sortBy = sortBySelect.value;
            viewOptions.filterByType = filterTypeSelect.value;
            viewOptions.filterByMethod = filterMethodSelect.value;
            renderTable();
        });
    });

    resetFiltersBtn.addEventListener('click', () => {
        sortBySelect.value = 'date_desc'; filterTypeSelect.value = 'all';
        filterMethodSelect.value = 'all'; searchInput.value = '';
        viewOptions = { sortBy: 'date_desc', filterByType: 'all', filterByMethod: 'all', searchTerm: '' };
        renderTable();
    });

    journalSelector.addEventListener('change', (e) => {
        appData.activeJournalId = e.target.value;
        saveDataToFirestore();
    });
    
    entryForm.addEventListener('submit', addEntry);
    editEntryForm.addEventListener('submit', updateEntry);
    createJournalBtn.addEventListener('click', createNewJournal);
    renameJournalBtn.addEventListener('click', renameActiveJournal);
    deleteJournalBtn.addEventListener('click', () => {
        const name = appData.journals[appData.activeJournalId]?.name;
        if(name) showConfirmationModal(`Delete '${name}' and all its entries? This cannot be undone.`, deleteActiveJournal);
    });
    
    tableBody.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-btn')) {
            showConfirmationModal("Are you sure you want to delete this entry?", () => deleteEntry(e.target.dataset.id));
        }
        if (e.target.classList.contains('edit-btn')) {
            openEditModal(e.target.dataset.id);
        }
    });

    modalConfirmBtn.addEventListener('click', () => {
        if (typeof confirmCallback === 'function') confirmCallback();
        confirmationModal.classList.add('hidden');
    });

    importBackupBtn.addEventListener('click', () => fileImporter.click());
    fileImporter.addEventListener('change', (event) => {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const importedData = JSON.parse(e.target.result);
                if (importedData && importedData.journals && importedData.activeJournalId) {
                    showConfirmationModal(
                        "This will overwrite ALL your cloud data with this backup. This cannot be undone.",
                        () => {
                            appData = importedData;
                            saveDataToFirestore().then(() => showToast("Backup imported successfully!", "success"));
                        }
                    );
                } else { throw new Error("Invalid backup file format."); }
            } catch (err) { showToast(err.message, "error"); }
        };
        reader.readAsText(file);
        event.target.value = null; 
    });
    
    // RESTORED: Download backup button event listener
    downloadBackupBtn.addEventListener('click', () => {
        if (!currentUser) return;
        const dataStr = JSON.stringify(appData, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `tck_backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        URL.revokeObjectURL(url);
    });

    // RESTORED: Download Excel button event listener
    downloadBtn.addEventListener('click', async () => {
        const activeJournal = appData.journals[appData.activeJournalId];
        if (!activeJournal || !activeJournal.entries || activeJournal.entries.length === 0) return;

        downloadBtn.disabled = true;
        showToast('Preparing your workbook...', 'info');

        try {
            const pyodide = await loadPy();
            pyodide.globals.set('entries_json', JSON.stringify(activeJournal.entries));
            pyodide.globals.set('journal_name_js', activeJournal.name);
            const base64Data = await pyodide.runPythonAsync(`
import json, io, base64
from datetime import datetime
from openpyxl import Workbook
from openpyxl.styles import Font, Alignment, PatternFill, Border, Side
from itertools import groupby
from collections import defaultdict
wb = Workbook()
ws = wb.active
ws.title = 'I&E Statement'
MIN_ROWS_PER_MONTH = 35
header_font = Font(name='Calibri', size=11, bold=True, color='FFFFFFFF')
subheader_font = Font(name='Calibri', size=11, bold=True)
vertical_month_font = Font(name='Calibri', size=28, bold=True)
data_font = Font(name='Calibri', size=11)
center_align = Alignment(horizontal='center', vertical='center', wrap_text=True)
vertical_align = Alignment(text_rotation=90, vertical='center', horizontal='center')
blue_fill = PatternFill(start_color='4472C4', end_color='4472C4', fill_type='solid')
orange_fill = PatternFill(start_color='ED7D31', end_color='ED7D31', fill_type='solid')
black_fill = PatternFill(start_color='000000', end_color='000000', fill_type='solid')
thin_side = Side(style='thin', color='000000')
thin_border = Border(left=thin_side, right=thin_side, top=thin_side, bottom=thin_side)
currency_format = '"UGX"* #,##0'
def create_month_table(worksheet, start_row, month_name, income_entries, expense_entries):
    worksheet.merge_cells(start_row=start_row, start_column=3, end_row=start_row, end_column=6); cell = worksheet.cell(start_row, 3); cell.value = 'INCOME'; cell.fill = blue_fill; cell.font = header_font; cell.alignment = center_align
    worksheet.merge_cells(start_row=start_row, start_column=8, end_row=start_row, end_column=12); cell = worksheet.cell(start_row, 8); cell.value = 'EXPENSES'; cell.fill = orange_fill; cell.font = header_font; cell.alignment = center_align
    worksheet.merge_cells(start_row=start_row+1, start_column=4, end_row=start_row+1, end_column=5); worksheet.merge_cells(start_row=start_row+1, start_column=9, end_row=start_row+1, end_column=11)
    headers3 = {'C':'Date', 'D':'Amount', 'F':'Narration', 'H':'Date', 'I':'Amount', 'L':'Reason'}
    for col_char, text in headers3.items():
        cell = worksheet[f'{col_char}{start_row+1}']; cell.value = text; cell.font = subheader_font; cell.alignment = center_align
    headers4 = {'D':'Mobile Money', 'E':'Bank', 'I':'Mobile Money', 'J':'Bank', 'K':'Cash'}
    for col_char, text in headers4.items():
        cell = worksheet[f'{col_char}{start_row+2}']; cell.value = text; cell.font = subheader_font; cell.alignment = center_align
    current_income_row = start_row + 3
    for date, group in groupby(income_entries, key=lambda x: x.get('date')):
        group_list = list(group)
        num_entries = len(group_list)
        date_obj = datetime.strptime(date, '%Y-%m-%d')
        date_cell = worksheet.cell(row=current_income_row, column=3, value=date_obj); date_cell.number_format = 'DD/MM/YYYY'; date_cell.font = data_font; date_cell.alignment = center_align
        if num_entries > 1: worksheet.merge_cells(start_row=current_income_row, start_column=3, end_row=current_income_row + num_entries - 1, end_column=3)
        for i, entry in enumerate(group_list):
            row_idx = current_income_row + i
            worksheet[f'F{row_idx}'].value = entry.get('narration'); worksheet[f'F{row_idx}'].font = data_font
            col = 'D' if entry.get('method') == 'Mobile Money' else 'E' if entry.get('method') == 'Bank' else ''
            if col: cell = worksheet[f'{col}{row_idx}']; cell.value = entry.get('amount'); cell.number_format = currency_format; cell.font = data_font
        current_income_row += num_entries
    current_expense_row = start_row + 3
    for date, group in groupby(expense_entries, key=lambda x: x.get('date')):
        group_list = list(group)
        num_entries = len(group_list)
        date_obj = datetime.strptime(date, '%Y-%m-%d')
        date_cell = worksheet.cell(row=current_expense_row, column=8, value=date_obj); date_cell.number_format = 'DD/MM/YYYY'; date_cell.font = data_font; date_cell.alignment = center_align
        if num_entries > 1: worksheet.merge_cells(start_row=current_expense_row, start_column=8, end_row=current_expense_row + num_entries - 1, end_column=8)
        for i, entry in enumerate(group_list):
            row_idx = current_expense_row + i
            worksheet[f'L{row_idx}'].value = entry.get('narration'); worksheet[f'L{row_idx}'].font = data_font
            col = 'I' if entry.get('method') == 'Mobile Money' else 'J' if entry.get('method') == 'Bank' else 'K' if entry.get('method') == 'Cash' else ''
            if col: cell = worksheet[f'{col}{row_idx}']; cell.value = entry.get('amount'); cell.number_format = currency_format; cell.font = data_font
        current_expense_row += num_entries
    table_end_row = max(current_income_row, current_expense_row, start_row + MIN_ROWS_PER_MONTH)
    for r in range(start_row, table_end_row):
        worksheet[f'G{r}'].fill = black_fill
        for c_ord in range(ord('C'), ord('M')):
            worksheet.cell(row=r, column=c_ord - ord('A') + 1).border = thin_border
    data_start_row = start_row + 3
    if data_start_row < table_end_row:
        worksheet.merge_cells(start_row=data_start_row, start_column=1, end_row=table_end_row - 1, end_column=1)
        cell = worksheet.cell(row=data_start_row, column=1); cell.value = month_name.upper(); cell.font = vertical_month_font; cell.alignment = vertical_align
    return table_end_row
entries = sorted([e for e in json.loads(entries_json) if e.get('date')], key=lambda x: x['date'])
monthly_data = defaultdict(lambda: {'income': [], 'expense': []})
for entry in entries:
    month_key = datetime.strptime(entry['date'], '%Y-%m-%d').strftime('%Y-%m')
    if entry['type'] == 'Income': monthly_data[month_key]['income'].append(entry)
    else: monthly_data[month_key]['expense'].append(entry)
current_row = 2
if not monthly_data: create_month_table(ws, current_row, journal_name_js, [], [])
else:
    for month_key in sorted(monthly_data.keys()):
        month_name = datetime.strptime(month_key, '%Y-%m').strftime('%B')
        data = monthly_data[month_key]
        current_row = create_month_table(ws, current_row, month_name, data['income'], data['expense']) + 3
column_widths = {'A': 5, 'B': 1, 'C': 12, 'D': 15, 'E': 15, 'F': 30, 'G': 1.5, 'H': 12, 'I': 15, 'J': 15, 'K': 15, 'L': 30}
for col, width in column_widths.items(): ws.column_dimensions[col].width = width
bio = io.BytesIO(); wb.save(bio)
base64.b64encode(bio.getvalue()).decode('utf-8')
`);
            showToast('Download starting...', 'success');
            const blob = Uint8Array.from(atob(base64Data), c => c.charCodeAt(0));
            const url = URL.createObjectURL(new Blob([blob], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }));
            const a = document.createElement('a');
            a.href = url;
            a.download = `${activeJournal.name.replace(/ /g, '_')}_Journal.xlsx`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        } catch (err) {
            console.error('Error generating file:', err);
            showToast('Error! Could not generate file.', 'error');
        } finally {
            downloadBtn.disabled = !activeJournal || !activeJournal.entries || activeJournal.entries.length === 0;
            statusMessage.textContent = '';
        }
    });

    modalCancelBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
    editCancelBtn.addEventListener('click', () => editEntryModal.classList.add('hidden'));
    document.addEventListener('DOMContentLoaded', () => dateInput.value = getFormattedDate(new Date()));

  </script>
</body>
</html>